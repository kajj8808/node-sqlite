<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/styles/reset.css" />
    <link rel="stylesheet" href="/styles/theme.css" />
    <link rel="stylesheet" href="/styles/gallery.css" />
  </head>
  <body>
    <div class="title-container">
      <h1 onclick="replacePage('/')">Image Gallery</h1>
      <h3></h3>
    </div>
    <div class="image_container"></div>
    <div class="image_viewer hidden">
      <button class="close_btn">âœ˜</button>
    </div>
    <footer></footer>
  </body>
  <script>
    let currentPage = 0;

    const imageContainer = document.querySelector(".image_container");
    const titleContainer = document.querySelector(".title-container");
    const imageViewer = document.querySelector(".image_viewer");
    const closeButton = document.querySelector(".close_btn");

    const subtitle = titleContainer.querySelector("h3");

    const footerContainer = document.querySelector("footer");

    const checkCurrentGroupName = (groupName) =>
      groupName === "group_one" ||
      groupName === "group_two" ||
      groupName === "all";

    const pathParts = window.location.pathname.split("/");
    const groupName = pathParts[pathParts.length - 1];

    function onImageClick(e) {
      imageViewer.style.backgroundImage = e.target.style.backgroundImage;
      imageViewer.classList.remove("hidden");
      imageViewer.classList.add("visible");
      lockScroll();
    }

    function onCloseClick() {
      imageViewer.classList.remove("visible");
      imageViewer.classList.add("hidden");
      unlockScroll();
    }

    function lockScroll() {
      document.body.style.overflow = "hidden";
    }

    function unlockScroll() {
      document.body.style.overflow = "";
    }

    function clearAllContent() {
      try {
        const subtitle = titleContainer.querySelector("h3");
        imageContainer.innerHTML = "";
        footerContainer.innerHTML = "";
        subtitle.innerText = "";
      } catch (error) {
        console.error(error);
      }
    }

    function renderContents(contents) {
      contents.map((content) => {
        const imageBox = document.createElement("div");
        imageBox.style.backgroundImage = `url("/image/${content.image}")`;
        imageBox.classList.add("image_box");
        imageBox.id = content.id;
        imageBox.addEventListener("click", onImageClick);

        imageContainer.appendChild(imageBox);
      });
    }

    function renderPaginationButtons({ groupName, pages }) {
      for (let page = 0; page < pages; page++) {
        const button = document.createElement("button");
        button.innerText = page + 1;

        if (currentPage === page) {
          button.classList.add("current_page");
        }

        button.addEventListener("click", () => {
          // page ê°€ 1ë¶€í„° ì‹œìž‘í•˜ëŠ” ê´€ê³„ë¡œ.. -1
          currentPage = page;
          fetchAndRenderGroup(groupName, page);
        });

        footerContainer.appendChild(button);
      }
    }

    async function fetchAndRenderGroup(groupName, page = 0) {
      // get data with aws server. ( 10ê°œì”© )
      const limit = 18;
      const offset = page * limit;
      const json = await (
        await fetch(
          `/get_contents/group?name=${groupName}&limit=${limit}&offset=${offset}`
        )
      ).json();
      // response ok
      if (json.ok) {
        // make images ... ðŸ˜Š
        const contents = json.contents;
        const totalPages = json.totalPages;
        // clear page!
        clearAllContent();
        // subtitle
        subtitle.innerText = groupName;
        titleContainer.appendChild(subtitle);
        // contents
        renderContents(contents);
        //groupName, json.totalPages
        renderPaginationButtons({
          groupName: groupName,
          pages: totalPages,
        });
      }
    }

    function replacePage(url) {
      location.assign(url);
    }

    async function main() {
      const body = document.querySelector("body");
      body.classList.add("visible");

      if (checkCurrentGroupName(groupName)) {
        fetchAndRenderGroup(groupName, 0);
      }
    }

    window.onload = () => {
      main();
    };

    imageViewer.addEventListener("click", onCloseClick);
    closeButton.addEventListener("click", onCloseClick);
  </script>
</html>
